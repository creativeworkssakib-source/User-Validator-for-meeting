<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Join Meeting — Validator</title>
  <style>
    :root{
      --bg1:#0b1220; --bg2:#112240;
      --accent1:#7c3aed; --accent2:#06b6d4;
      --ok:#10b981; --err:#ef4444; --muted:#9aa4b2;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial}
    body{
      display:grid;place-items:center;
      background: radial-gradient(800px 440px at 10% 10%, rgba(124,58,237,0.06), transparent),
                  radial-gradient(600px 320px at 90% 90%, rgba(6,182,212,0.04), transparent),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      padding:28px;color:#e6eef8;
    }
    .card{width:100%;max-width:420px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:28px;box-shadow:0 18px 60px rgba(2,6,23,0.6)}
    h1{font-size:20px;margin:6px 0 6px;text-align:center}
    p.lead{margin:0 0 18px;text-align:center;color:var(--muted);font-size:13px}
    label{display:block;margin:8px 0 6px;color:var(--muted)}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:inherit;margin-bottom:10px}
    button{width:100%;padding:12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;font-weight:700;cursor:pointer}
    .status{margin-top:12px;text-align:center;font-size:14px;min-height:24px}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--err)}
    .debug{margin-top:10px;background:#061026;padding:10px;border-radius:8px;color:#cfeee0;font-size:13px;white-space:pre-wrap;max-height:160px;overflow:auto}
    .joinBtn{margin-top:12px;background:#0b8454;padding:10px;border-radius:8px;color:white;text-decoration:none;display:inline-block}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="title">
    <h1 id="title">Join Zoom Meeting</h1>
    <p class="lead">Enter name and email to validate access</p>

    <label for="name">Full name</label>
    <input id="name" placeholder="Your full name" />

    <label for="email">Email address</label>
    <input id="email" type="email" placeholder="you@example.com" />

    <button id="submit">Validate & Join</button>

    <div id="status" class="status" aria-live="polite"></div>

    <!-- shown only when matched -->
    <div id="joinArea" class="hidden" style="text-align:center">
      <a id="joinLink" class="joinBtn" href="#" target="_blank" rel="noopener">Join meeting now</a>
    </div>

    <!-- debug area (optional) -->
    <div id="debug" class="debug" aria-hidden="true">No requests yet.</div>
  </div>

<script>
  // ---------- CONFIG ----------
  // Use the test webhook URL you provided
  const WEBHOOK_TEST = 'https://server3.automationlearners.pro/webhook-test/f559db8e-b719-41bd-85ab-0547207e38ef';
  // fallback zoom join link (if webhook doesn't return a redirect)
  const FALLBACK_ZOOM = 'https://zoom.us/j/1234567890'; // replace with real meeting join link
  // -----------------------------

  const nameEl = document.getElementById('name');
  const emailEl = document.getElementById('email');
  const submitBtn = document.getElementById('submit');
  const statusEl = document.getElementById('status');
  const debugEl = document.getElementById('debug');
  const joinArea = document.getElementById('joinArea');
  const joinLink = document.getElementById('joinLink');

  function setStatus(text, type){
    statusEl.textContent = text;
    statusEl.className = 'status' + (type ? ' ' + type : '');
  }

  function setDebug(text){
    debugEl.textContent = text;
    // show debug for diagnosing; if you want hide remove next line
    debugEl.setAttribute('aria-hidden','false');
  }

  function determineMatchFromResponse(bodyText, json){
    // Heuristic checks to decide whether the server reported a match:
    // 1) If JSON contains explicit boolean fields like ok, valid, matched
    // 2) If JSON contains an array of items/records with length > 0
    // 3) If JSON is an object that contains Name/Email/id fields
    // 4) If response text includes 'match' or 'found' (case-insensitive)
    try {
      if(json){
        const lowerKeys = Object.keys(json).map(k=>k.toLowerCase());
        // explicit boolean flags
        if('valid' in json && typeof json.valid === 'boolean') return json.valid;
        if('ok' in json && typeof json.ok === 'boolean') return json.ok;
        if('matched' in json && typeof json.matched === 'boolean') return json.matched;

        // arrays (items, data, records)
        if(Array.isArray(json)){
          if(json.length > 0) return true;
        }
        if(json.items && Array.isArray(json.items) && json.items.length > 0) return true;
        if(json.records && Array.isArray(json.records) && json.records.length > 0) return true;
        if(json.data && Array.isArray(json.data) && json.data.length > 0) return true;

        // object with fields that indicate a found record
        const hasName = Object.values(json).some(v => typeof v === 'string' && /[A-Za-z]/.test(v) && v.length>1);
        const hasEmail = Object.values(json).some(v => typeof v === 'string' && v.includes('@'));
        if(hasEmail || hasName) {
          // be conservative: if both present treat as match; if one present still treat as match.
          return hasEmail || hasName;
        }
      }

      // fallback: text analysis
      if(typeof bodyText === 'string'){
        const t = bodyText.toLowerCase();
        if(t.includes('match') || t.includes('found') || t.includes('ok') || t.includes('authorized')) return true;
        if(t.includes('not found') || t.includes('not authorized') || t.includes('no match') || t.includes('not authorized')) return false;
      }
    } catch(e){
      console.error('determineMatchFromResponse error', e);
    }
    return false;
  }

  async function sendTest(){
    const name = nameEl.value.trim();
    const email = emailEl.value.trim();

    // basic validation
    if(!name || !email){
      setStatus('Please enter both name and email.', 'err');
      joinArea.classList.add('hidden');
      return;
    }

    setStatus('Sending...', '');
    debugEl.textContent = 'Sending request...';
    submitBtn.disabled = true;
    joinArea.classList.add('hidden');

    const payload = { name: name, email: email, ts: new Date().toISOString() };

    try {
      const controller = new AbortController();
      const timeout = setTimeout(()=> controller.abort(), 12000);

      const resp = await fetch(WEBHOOK_TEST, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
        body: JSON.stringify(payload),
        signal: controller.signal
      });

      clearTimeout(timeout);

      const statusLine = `HTTP ${resp.status} ${resp.statusText}`;
      let text = '';
      try { text = await resp.text(); } catch(e){ text = '<no body>'; }
      setDebug(statusLine + '\n\n' + 'Response body:\n' + text);

      // try parse JSON
      let json = null;
      try { json = JSON.parse(text); } catch(e){ json = null; }

      const matched = determineMatchFromResponse(text, json);

      if(matched){
        setStatus('Match found — you may join the meeting.', 'ok');
        // if webhook returned a redirect or join link, prefer it:
        let joinUrl = FALLBACK_ZOOM; // use fallback if nothing in response
        try {
          if(json){
            // common places where a join URL may be returned
            if(json.redirect && typeof json.redirect === 'string') joinUrl = json.redirect;
            else if(json.joinUrl && typeof json.joinUrl === 'string') joinUrl = json.joinUrl;
            else if(json.url && typeof json.url === 'string') joinUrl = json.url;
            else if(Array.isArray(json) && json[0] && json[0].joinUrl) joinUrl = json[0].joinUrl;
            // also inspect nested items arrays
            if(json.items && json.items[0] && json.items[0].joinUrl) joinUrl = json.items[0].joinUrl;
          }
        } catch(e){
          console.warn('join url parse error', e);
        }
        joinLink.href = joinUrl || FALLBACK_ZOOM;
        joinArea.classList.remove('hidden');
      } else {
        setStatus('No match found — you may not join the meeting.', 'err');
        joinArea.classList.add('hidden');
      }

    } catch (err){
      console.error('Request error', err);
      const msg = err && err.name === 'AbortError' ? 'Request timed out.' : (err && err.message ? err.message : 'Network error');
      setStatus('Request failed: ' + msg, 'err');
      setDebug('Request error: ' + (err && err.message ? err.message : String(err)) + '\n\nOpen DevTools Network/Console for details.');
    } finally {
      submitBtn.disabled = false;
    }
  }

  // fallback zoom link constant available inside function scope
  const FALLBACK_ZOOM = 'https://zoom.us/j/1234567890';

  document.getElementById('submit').addEventListener('click', sendTest);
</script>
</body>
</html>
