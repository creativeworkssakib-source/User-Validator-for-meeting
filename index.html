<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Join Zoom Meeting — Validator</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap');
  :root{
    --bg1:#6b46c1; --bg2:#7c3aed;
    --card:#0b1220;
    --muted:#9aa4b2;
    --ok:#10b981; --err:#ef4444;
    --accent1:#7c3aed; --accent2:#06b6d4;
  }
  *{box-sizing:border-box}
  body{margin:0;height:100vh;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:linear-gradient(135deg,#0b1220,#111827);display:flex;align-items:center;justify-content:center;padding:24px;color:#e6eef8}
  .card{width:100%;max-width:420px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:28px;box-shadow:0 18px 60px rgba(2,6,23,0.7);position:relative;overflow:hidden}
  .logo{width:56px;height:44px;border-radius:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;margin:0 auto 10px;box-shadow:0 12px 30px rgba(0,0,0,0.45)}
  h1{font-size:20px;margin:6px 0 6px;text-align:center}
  p.lead{margin:0 0 18px;text-align:center;color:var(--muted);font-size:13px}
  label{display:block;margin:8px 0 6px;color:var(--muted);font-size:13px}
  input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:inherit;margin-bottom:10px;outline:none;font-size:14px;transition:box-shadow .12s,transform .08s}
  input:focus{box-shadow:0 10px 30px rgba(2,6,23,0.5);transform:translateY(-1px);border-color:rgba(255,255,255,0.12)}
  .actions{display:flex;gap:10px;margin-top:6px}
  button.primary{flex:1;padding:12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(124,58,237,0.12)}
  .status{margin-top:12px;text-align:center;font-size:15px;min-height:28px}
  .badge{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;font-weight:700}
  .badge.ok{background:rgba(16,185,129,0.12);color:var(--ok)}
  .badge.err{background:rgba(239,68,68,0.08);color:var(--err)}
  .joinBtn{display:inline-block;margin-top:12px;padding:10px 14px;border-radius:10px;background:#0b8454;color:white;text-decoration:none;font-weight:700}
  .debug{margin-top:14px;background:#071029;padding:12px;border-radius:10px;color:#cfeee0;font-size:13px;white-space:pre-wrap;max-height:180px;overflow:auto;display:none}
  .toggleDebug{display:block;text-align:center;margin-top:10px;color:var(--muted);font-size:13px;cursor:pointer}
  .small{font-size:13px;color:var(--muted);text-align:center;margin-top:8px}
  .hidden{display:none}
  .spinner{display:inline-block;width:16px;height:16px;border-radius:50%;border:3px solid rgba(255,255,255,0.12);border-top-color:rgba(255,255,255,0.95);animation:spin .9s linear infinite;vertical-align:middle;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media (max-width:480px){ .card{padding:20px} h1{font-size:18px} }
</style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="title">
    <div class="logo" aria-hidden="true">ZM</div>
    <h1 id="title">Join Zoom Meeting</h1>
    <p class="lead">Enter your name and email to check access</p>

    <label for="name">Full name</label>
    <input id="name" type="text" placeholder="Your full name">

    <label for="email">Email address</label>
    <input id="email" type="email" placeholder="you@example.com">

    <div class="actions">
      <button id="submit" class="primary" type="button">Validate & Join</button>
    </div>

    <div id="status" class="status" aria-live="polite"></div>

    <div id="joinArea" class="hidden" style="text-align:center">
      <a id="joinLink" class="joinBtn" href="#" target="_blank" rel="noopener">Click here to join the meeting</a>
      <div class="small">Or wait — you will be redirected automatically in 2 seconds.</div>
    </div>

    <div id="debugToggle" class="toggleDebug">Show debug response</div>
    <pre id="debug" class="debug" aria-hidden="true">No requests yet.</pre>
  </main>

<script>
/* ========== CONFIG ========== */
// Use the test webhook you provided (n8n test URL)
const WEBHOOK = 'https://server3.automationlearners.pro/webhook-test/f559db8e-b719-41bd-85ab-0547207e38ef';

// Fallback meeting link (replace with your actual meeting link)
const FALLBACK_JOIN = 'https://zoom.us/j/1234567890';
/* ============================ */

const nameEl = document.getElementById('name');
const emailEl = document.getElementById('email');
const submitBtn = document.getElementById('submit');
const statusEl = document.getElementById('status');
const debugEl = document.getElementById('debug');
const debugToggle = document.getElementById('debugToggle');
const joinArea = document.getElementById('joinArea');
const joinLink = document.getElementById('joinLink');

function setLoading(on){
  if(on){
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner" aria-hidden="true"></span>Checking...';
  } else {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Validate & Join';
  }
}

function setResultMatched(joinUrl){
  statusEl.innerHTML = '<span class="badge ok">✔ Match found — you may join the meeting.</span>';
  joinLink.href = joinUrl || FALLBACK_JOIN;
  joinArea.classList.remove('hidden');
  // auto-redirect after short pause
  setTimeout(()=>{ window.open(joinLink.href, '_blank'); }, 2000);
}

function setResultNotMatched(){
  statusEl.innerHTML = '<span class="badge err">✖ No match found — you may not join the meeting.</span>';
  joinArea.classList.add('hidden');
}

function showDebug(text){
  debugEl.textContent = text;
  debugEl.style.display = 'block';
  debugEl.setAttribute('aria-hidden','false');
}

debugToggle.addEventListener('click', () => {
  if(debugEl.style.display === 'block'){ debugEl.style.display = 'none'; debugEl.setAttribute('aria-hidden','true'); debugToggle.textContent = 'Show debug response'; }
  else { debugEl.style.display = 'block'; debugEl.setAttribute('aria-hidden','false'); debugToggle.textContent = 'Hide debug response'; }
});

// simple heuristic that determines match from webhook response (JSON or text)
function isMatchFromResponse(text, json){
  try{
    if(json){
      // explicit boolean flags
      if('valid' in json && typeof json.valid === 'boolean') return json.valid;
      if('ok' in json && typeof json.ok === 'boolean') return json.ok;
      if('matched' in json && typeof json.matched === 'boolean') return json.matched;

      // arrays indicating found items
      if(Array.isArray(json) && json.length > 0) return true;
      if(json.items && Array.isArray(json.items) && json.items.length > 0) return true;
      if(json.records && Array.isArray(json.records) && json.records.length > 0) return true;
      if(json.data && Array.isArray(json.data) && json.data.length > 0) return true;

      // object fields: if contains email or name values
      const anyString = Object.values(json).some(v => typeof v === 'string' && v.length>2);
      const hasEmail = (JSON.stringify(json)).includes('@');
      if(hasEmail || anyString) return hasEmail || anyString;
    }

    if(typeof text === 'string'){
      const t = text.toLowerCase();
      if(t.includes('match') || t.includes('found') || t.includes('authorized') || t.includes('ok')) return true;
      if(t.includes('not found') || t.includes('not authorized') || t.includes('no match') || t.includes('not authorized')) return false;
    }
  } catch(e){
    console.warn('match detection error', e);
  }
  return false;
}

async function submit(){
  const name = nameEl.value.trim();
  const email = emailEl.value.trim();

  // basic client-side validation
  if(!name || !email){
    statusEl.innerHTML = '<span class="badge err">Please enter both name and email.</span>';
    joinArea.classList.add('hidden');
    return;
  }

  setLoading(true);
  statusEl.textContent = '';
  debugEl.textContent = 'Sending request...';

  const payload = { name, email, ts: new Date().toISOString() };

  try{
    // fetch with 12s timeout
    const controller = new AbortController();
    const timeout = setTimeout(()=> controller.abort(), 12000);

    const resp = await fetch(WEBHOOK, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    clearTimeout(timeout);

    const statusLine = `HTTP ${resp.status} ${resp.statusText}`;
    let bodyText = '';
    try { bodyText = await resp.text(); } catch(e){ bodyText = '<no body>'; }

    // show debug (toggleable)
    showDebug(statusLine + '\n\n' + bodyText);

    // attempt parse JSON
    let json = null;
    try { json = JSON.parse(bodyText); } catch(e){ json = null; }

    const matched = isMatchFromResponse(bodyText, json);

    if(matched){
      // prefer any URLs returned by webhook (json.redirect/json.joinUrl/json.url)
      let joinUrl = FALLBACK_JOIN;
      try {
        if(json){
          if(typeof json.redirect === 'string') joinUrl = json.redirect;
          else if(typeof json.joinUrl === 'string') joinUrl = json.joinUrl;
          else if(typeof json.url === 'string') joinUrl = json.url;
          else if(Array.isArray(json) && json[0] && json[0].joinUrl) joinUrl = json[0].joinUrl;
          else if(json.items && json.items[0] && json.items[0].joinUrl) joinUrl = json.items[0].joinUrl;
        }
      } catch(e){ console.warn('join url read error', e); }

      setResultMatched(joinUrl);
    } else {
      setResultNotMatched();
    }

  } catch(err){
    console.error('Request error', err);
    const em = err && err.name === 'AbortError' ? 'Request timed out' : (err && err.message ? err.message : 'Network error');
    statusEl.innerHTML = `<span class="badge err">Request failed: ${em}. See debug for details.</span>`;
    showDebug(String(err));
    joinArea.classList.add('hidden');
  } finally {
    setLoading(false);
  }
}

submitBtn.addEventListener('click', submit);
</script>
</body>
</html>
